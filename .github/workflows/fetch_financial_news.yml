name: Fetch Financial News

on:
  schedule:
    # ğŸ• 5ë¶„ë§ˆë‹¤ ì‹¤í–‰ (UTC ê¸°ì¤€)
    - cron: '*/5 * * * *'
  workflow_dispatch: 
    inputs:
      debug:
        description: 'ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™”'
        required: false
        default: false
        type: boolean

env:
  # ğŸŒ íƒ€ì„ì¡´ ì„¤ì • (í•œêµ­ì‹œê°„ ê¸°ì¤€)
  TZ: Asia/Seoul

jobs:
  fetch:
    name: ğŸ“° Financial News ìˆ˜ì§‘
    runs-on: ubuntu-latest
    timeout-minutes: 3
    concurrency:
      group: fetch-financial-news
      cancel-in-progress: false
    
    steps:
      - name: ğŸ“Œ ì‚¬ì „ ìŠ¤ëƒ…ìƒ·(max created_at)
        id: snapshot
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          set -euo pipefail
          SNAP=$(curl -sS \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
            -H "apikey: $SUPABASE_ANON_KEY" \
            "$SUPABASE_URL/rest/v1/news_items?select=max(created_at)")
          # Expect format: [{"max":"2025-11-01T04:40:12+00:00"}]
          PRE_MAX=$(echo "$SNAP" | jq -r '.[0].max // empty')
          echo "pre_max=$PRE_MAX" >> $GITHUB_OUTPUT
          echo "ì‚¬ì „ ìµœëŒ€ created_at: ${PRE_MAX:-<none>}"

      - name: ğŸš€ ì›Œí¬í”Œë¡œ ì‹œì‘
        run: |
          echo "ğŸ• ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ğŸ¯ ëŒ€ìƒ: Supabase Edge Function"
          echo "ğŸ”§ ë””ë²„ê·¸ ëª¨ë“œ: ${{ github.event.inputs.debug || 'false' }}"

      - name: ğŸ“¡ Supabase Edge Function í˜¸ì¶œ (curl)
        id: invoke
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          set -euo pipefail
          URL="$SUPABASE_URL/functions/v1/fetch_financial_news"
          echo "ğŸ”— $URL"
          # Perform request with Authorization (and apikey for good measure)
          HTTP_CODE=$(curl -sS \
            --retry 3 --retry-delay 3 \
            --connect-timeout 10 --max-time 60 \
            -o /tmp/resp.json -w "%{http_code}" \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
            -H "apikey: $SUPABASE_ANON_KEY" \
            "$URL" || echo "000")
          echo "HTTP $HTTP_CODE"
          cat /tmp/resp.json || true
          echo "status=$HTTP_CODE" >> $GITHUB_OUTPUT
          BODY=$(cat /tmp/resp.json 2>/dev/null || echo "")
          # Fail on server error
          if [ "$HTTP_CODE" -ge 500 ]; then
            exit 1
          fi

      - name: ğŸ“ˆ ì´ë²ˆ íšŒì°¨ ìš”ì•½(ì†ŒìŠ¤ë³„ ì‹ ê·œ ê±´ìˆ˜)
        if: ${{ steps.snapshot.outputs.pre_max != '' }}
        id: batch_summary
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          set -euo pipefail
          PRE_MAX='${{ steps.snapshot.outputs.pre_max }}'
          echo "PRE_MAX=$PRE_MAX"
          # Group by source since last snapshot
          RESP=$(curl -sS \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
            -H "apikey: $SUPABASE_ANON_KEY" \
            "$SUPABASE_URL/rest/v1/news_items?select=source,count:count()&created_at=gt.$PRE_MAX&group=source")
          echo "$RESP" | jq .
          # Extract counts
          TOTAL=$(echo "$RESP" | jq '[.[].count] | add // 0')
          FJ=$(echo "$RESP" | jq 'map(select(.source=="Financial Juice")) | (.[0].count // 0)')
          SAVE=$(echo "$RESP" | jq 'map(select(.source=="SaveTicker")) | (.[0].count // 0)')
          echo "ì´ë²ˆ íšŒì°¨: ì´ ${TOTAL}ê±´ (Financial Juice: ${FJ}, SaveTicker: ${SAVE})"
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "fj=$FJ" >> $GITHUB_OUTPUT
          echo "save=$SAVE" >> $GITHUB_OUTPUT

      - name: ğŸ“Š ì‘ë‹µ ê²°ê³¼ ì¶œë ¥
        run: |
          echo "ğŸ“ˆ HTTP ìƒíƒœ: ${{ steps.invoke.outputs.status }}"
          echo ""
          echo "ğŸ“„ ì‘ë‹µ ë‚´ìš©:"
          echo "(ìœ„ ë‹¨ê³„ì—ì„œ ì¶œë ¥ë¨)"

      - name: âœ… ì„±ê³µ í†µê³„
        if: ${{ fromJSON(steps.invoke.outputs['status']) >= 200 && fromJSON(steps.invoke.outputs['status']) < 300 }}
        run: |
          echo "ğŸ‰ ë‰´ìŠ¤ ìˆ˜ì§‘ ì„±ê³µ!"
          echo "ğŸ“Š ìƒíƒœ ì½”ë“œ: ${{ steps.invoke.outputs.status }}"
          echo "â° ì™„ë£Œ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          if [ -n "${{ steps.batch_summary.outputs.total }}" ]; then
            echo "ğŸ§¾ ì´ë²ˆ íšŒì°¨: ì´ ${{ steps.batch_summary.outputs.total }}ê±´ (Financial Juice: ${{ steps.batch_summary.outputs.fj }}, SaveTicker: ${{ steps.batch_summary.outputs.save }})"
          fi

      - name: âš ï¸ í´ë¼ì´ì–¸íŠ¸ ì—ëŸ¬ (4xx)
        if: ${{ fromJSON(steps.invoke.outputs['status']) >= 400 && fromJSON(steps.invoke.outputs['status']) < 500 }}
        run: |
          echo "âŒ í´ë¼ì´ì–¸íŠ¸ ì—ëŸ¬ ë°œìƒ!"
          echo "ğŸ” Secrets ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”"
          echo ""
          echo "ğŸ› ï¸ í•´ê²° ë°©ë²•:"
          echo "  1. ./scripts/setup_github_actions_secrets.sh ì‹¤í–‰"
          echo "  2. Supabase í”„ë¡œì íŠ¸ ì„¤ì • í™•ì¸"
          echo "  3. Edge Function ë°°í¬ ìƒíƒœ í™•ì¸"
          exit 1

      - name: ğŸš¨ ì„œë²„ ì—ëŸ¬ (5xx)
        if: ${{ fromJSON(steps.invoke.outputs['status']) >= 500 }}
        run: |
          echo "ğŸ’¥ ì„œë²„ ì—ëŸ¬ ë°œìƒ!"
          echo "ğŸ” Supabase ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”:"
          echo "  - Edge Function ë¡œê·¸ í™•ì¸"
          echo "  - ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ìƒíƒœ í™•ì¸"
          echo "  - API ì‚¬ìš©ëŸ‰ í•œë„ í™•ì¸"
          echo ""
          echo "ğŸ“ ì§€ì›: https://supabase.com/docs/guides/functions/debugging"
          exit 1

      - name: ğŸ› ë””ë²„ê·¸ ì •ë³´ ì¶œë ¥
        if: ${{ github.event.inputs.debug == 'true' || failure() }}
        run: |
          echo "ğŸ” ë””ë²„ê·¸ ì •ë³´:"
          echo "  - ì›Œí¬í”Œë¡œ ID: ${{ github.run_id }}"
          echo "  - ì‹¤í–‰ ë²ˆí˜¸: ${{ github.run_number }}"
          echo "  - ë¸Œëœì¹˜: ${{ github.ref_name }}"
          echo "  - ì»¤ë°‹: ${{ github.sha }}"
          echo "  - íŠ¸ë¦¬ê±°: ${{ github.event_name }}"
          echo ""
          echo "ğŸŒ í™˜ê²½ ë³€ìˆ˜:"
          echo "  - GITHUB_REPOSITORY: ${{ github.repository }}"
          echo "  - GITHUB_ACTOR: ${{ github.actor }}"
          echo "  - RUNNER_OS: ${{ runner.os }}"
