name: Fetch Financial News

on:
  schedule:
    # ğŸ• 5ë¶„ë§ˆë‹¤ ì‹¤í–‰ (UTC ê¸°ì¤€)
    - cron: '*/5 * * * *'
  workflow_dispatch: 
    inputs:
      debug:
        description: 'ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™”'
        required: false
        default: false
        type: boolean

env:
  # ğŸŒ íƒ€ì„ì¡´ ì„¤ì • (í•œêµ­ì‹œê°„ ê¸°ì¤€)
  TZ: Asia/Seoul

jobs:
  fetch:
    name: ğŸ“° Financial News ìˆ˜ì§‘
    runs-on: ubuntu-latest
    timeout-minutes: 3
    concurrency:
      group: fetch-financial-news
      cancel-in-progress: false
    
    steps:
      - name: ğŸš€ ì›Œí¬í”Œë¡œ ì‹œì‘
        run: |
          echo "ğŸ• ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ğŸ¯ ëŒ€ìƒ: Supabase Edge Function"
          echo "ğŸ”§ ë””ë²„ê·¸ ëª¨ë“œ: ${{ github.event.inputs.debug || 'false' }}"

      - name: ğŸ“¡ Supabase Edge Function í˜¸ì¶œ (github-script)
        id: invoke
        uses: actions/github-script@v7
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        with:
          script: |
            const url = `${process.env.SUPABASE_URL}/functions/v1/fetch_financial_news`;
            const headers = {
              'Authorization': `Bearer ${process.env.SUPABASE_ANON_KEY}`,
              'apikey': process.env.SUPABASE_ANON_KEY,
              'User-Agent': 'InvestFlow-GitHub-Actions/1.0'
            };
            const res = await fetch(url, { method: 'GET', headers });
            const text = await res.text();
            core.info(`HTTP ${res.status}`);
            core.info(text);
            core.setOutput('status', res.status);
            core.setOutput('body', text);
            if (res.status >= 500) core.setFailed(`Server error ${res.status}`);

      - name: ğŸ“Š ì‘ë‹µ ê²°ê³¼ ì¶œë ¥
        run: |
          echo "ğŸ“ˆ HTTP ìƒíƒœ: ${{ steps.invoke.outputs.status }}"
          echo ""
          echo "ğŸ“„ ì‘ë‹µ ë‚´ìš©:"
          response='${{ steps.invoke.outputs.body }}'
          if echo "$response" | jq . >/dev/null 2>&1; then
            echo "$response" | jq .
          else
            printf '%b\n' "$response"
          fi

      - name: âœ… ì„±ê³µ í†µê³„
        if: ${{ fromJSON(steps.invoke.outputs['status']) >= 200 && fromJSON(steps.invoke.outputs['status']) < 300 }}
        run: |
          echo "ğŸ‰ ë‰´ìŠ¤ ìˆ˜ì§‘ ì„±ê³µ!"
          echo "ğŸ“Š ìƒíƒœ ì½”ë“œ: ${{ steps.invoke.outputs.status }}"
          echo "â° ì™„ë£Œ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S %Z')"

      - name: âš ï¸ í´ë¼ì´ì–¸íŠ¸ ì—ëŸ¬ (4xx)
        if: ${{ fromJSON(steps.invoke.outputs['status']) >= 400 && fromJSON(steps.invoke.outputs['status']) < 500 }}
        run: |
          echo "âŒ í´ë¼ì´ì–¸íŠ¸ ì—ëŸ¬ ë°œìƒ!"
          echo "ğŸ” Secrets ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”"
          echo ""
          echo "ğŸ› ï¸ í•´ê²° ë°©ë²•:"
          echo "  1. ./scripts/setup_github_actions_secrets.sh ì‹¤í–‰"
          echo "  2. Supabase í”„ë¡œì íŠ¸ ì„¤ì • í™•ì¸"
          echo "  3. Edge Function ë°°í¬ ìƒíƒœ í™•ì¸"
          exit 1

      - name: ğŸš¨ ì„œë²„ ì—ëŸ¬ (5xx)
        if: ${{ fromJSON(steps.invoke.outputs['status']) >= 500 }}
        run: |
          echo "ğŸ’¥ ì„œë²„ ì—ëŸ¬ ë°œìƒ!"
          echo "ğŸ” Supabase ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”:"
          echo "  - Edge Function ë¡œê·¸ í™•ì¸"
          echo "  - ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ìƒíƒœ í™•ì¸"
          echo "  - API ì‚¬ìš©ëŸ‰ í•œë„ í™•ì¸"
          echo ""
          echo "ğŸ“ ì§€ì›: https://supabase.com/docs/guides/functions/debugging"
          exit 1

      - name: ğŸ› ë””ë²„ê·¸ ì •ë³´ ì¶œë ¥
        if: ${{ github.event.inputs.debug == 'true' || failure() }}
        run: |
          echo "ğŸ” ë””ë²„ê·¸ ì •ë³´:"
          echo "  - ì›Œí¬í”Œë¡œ ID: ${{ github.run_id }}"
          echo "  - ì‹¤í–‰ ë²ˆí˜¸: ${{ github.run_number }}"
          echo "  - ë¸Œëœì¹˜: ${{ github.ref_name }}"
          echo "  - ì»¤ë°‹: ${{ github.sha }}"
          echo "  - íŠ¸ë¦¬ê±°: ${{ github.event_name }}"
          echo ""
          echo "ğŸŒ í™˜ê²½ ë³€ìˆ˜:"
          echo "  - GITHUB_REPOSITORY: ${{ github.repository }}"
          echo "  - GITHUB_ACTOR: ${{ github.actor }}"
          echo "  - RUNNER_OS: ${{ runner.os }}"
